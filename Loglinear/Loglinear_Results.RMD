---
title: "Cell type composition differences"
output:
  html_document:
  theme: united
code_folding: show
toc: true
toc_float: true
toc_collapse: false
---

## Data setup for loglinear model

```{r libraries}
#packages
suppressMessages(c(require(dplyr),
require(rjags),
require(coda),
require(knitr),
require(kableExtra),
require(magrittr)
))

#file path
PATH <- file.path("/Users/tanyatk/scc_remote/montilab-p/personal/tanya/scRNA-aging/GM_centenarians/Composition/")

```

Dataset for rjags model:

* n.sample = total number of samples
* n.ct = total number of cell types
* N = cell counts per sample
* X = sample by cell type matrix of cell counts 
* age.group = controls (1) v. centenarians (2)
* batch = datasets: PNAS (1), NATGEN (2), NECS Batch1 (3), NECS Batch2 (4)
* sex = Male (1) v. Female (2)

```{r rjags data, attr.output='style="max-height: 500px;"'}
data <- readRDS("rjags.data.rds")
data
```

## Running loglinear model

Monitor: 

* fit.YM, fit.YF, Fit.OM, Fit.OF (probability of cell types for younger males, younger females, older males, and younger females)
```{r rjags run, attr.output='style="max-height: 100px;"'}
set.seed(123)
#source model
source("~/poisson.multi.rjags.R")

# Run rjags model and monitor variables

#cell type probabilities by groups: younger males, younger females, older males, older females
#assuming coming from the same batch of data
jags <- jags.model(textConnection(model),data=data, n.adapt=1500, n.chains = 2)
res <- coda.samples(jags, c('fit.YM','fit.F','fit.OM','fit.OF'), n.iter=10000)
```
## Results

### Probabilities of cell types for four groups: younger males, younger females, older males, and older females

Extract probabilities and credible intervals
```{r prob group}
#extract summary results from mcmc output
coda.summary <- summary(res)
#create a matrix to store probabilities, credible interval 2.5%, credible interval 97.5%
rates <- matrix(coda.summary$statistics[,"Mean"], nrow = data$n.ct, ncol=4)
rownames(rates) <- colnames(data$X)
colnames(rates) <- c("Older Female", "Older Male", "Younger Female", "Younger Male")

CI.2.5 <- matrix(coda.summary1$quantiles[,"2.5%"], nrow = data$n.ct, ncol=4)
rownames(CI.2.5) <- colnames(data$X)
colnames(CI.2.5) <- c("Older Female", "Older Male", "Younger Female", "Younger Male")

CI.97.5 <- matrix(coda.summary1$quantiles[,"97.5%"], nrow = data$n.ct, ncol=4)
rownames(CI.97.5) <- colnames(data$X)
colnames(CI.97.5) <- c("Older Female", "Older Male", "Younger Female", "Younger Male")

```


```{r traceplot, eval = F, echo = F}
#density plots, trace plots to determine model convergence
#require('mcmcplots')
#mcmcplot(res2,parms = c("fit3.YM", "fit3.YF", "fit3.OM", "fit3.OF"), dir = paste0(work.dir, "MCMC.refNATGEN"), filename = "MCMCoutput.refNATGEN")


plot(res1)
plot(res2)

autocorr.plot(res1)
autocorr.plot(res2)

```

Forest plot of probabilities and credible intervals across groups for each cell type:

```{r forest group, fig.height=20, fig.width=40}

df <- lapply(1:nrow(rates), function(i){
df <- data.frame(sample = colnames(rates), cell.type = rep(rownames(rates)[i],4), age.group = c(rep("EL",2), rep("CT", 2)), rate = rates[i,], CI.2.5 = CI.2.5[i,], CI.97.5 = CI.97.5[i,])
return(df)
})

df <- do.call(rbind, df)

df$sample <- factor(df$sample, levels = c("Younger Male", "Younger Female", "Older Male", "Older Female"))


#Forest plot of probabilities for each group across cell types
#same scale for all figures

library(ggplot2)
fp <- ggplot(data=df) +
        geom_pointrange(aes(x=sample, y=rate, ymin=CI.2.5, ymax=CI.97.5, group=age.group, color=age.group), 
            position = position_dodge(width = 1))+
        facet_wrap(~cell.type, ncol = 5) +  
        xlab("sample") + ylab("Rate (95% CI)") +
        theme_bw(base_size = 20)  # use a white background
fp

#Forest plot of probabilities for each group across cell types
#different scale for all figures
fp <- ggplot(data=df) +
        geom_pointrange(aes(x=sample, y=rate, ymin=CI.2.5, ymax=CI.97.5, group=age.group, color=age.group), 
            position = position_dodge(width = 1))+
        facet_wrap(~cell.type, ncol = 5, scale = 'free') +  
        xlab("sample") + ylab("Rate (95% CI)") +
        theme_bw(base_size = 20)  # use a white background
fp



```


